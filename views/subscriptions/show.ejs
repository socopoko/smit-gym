<%- include('../partials/header') %>
<%- include ('../partials/messages') %>
<h1>Subscription Information of <%= user.name %></h1>


<% if (subscription == null) { %>
    <form action="/subscription" method="POST">
        <select name="amount" id="amount">
            <option value="400" default>Rs. 400 - 1 months</option>
            <option value="800">Rs. 1200 - 3 months</option>
            <option value="1200">Rs. 2400 - 6 months</option>
            <option value="4800">Rs. 4800 - 12 months</option>
        </select>
        <div id="card-element"></div>
        <div id="card-errors" role="alert"></div>
        <button>Pay</button>
    </form>
<% } else if(subscription.date < subscription.expiry) { %>
    <h2>You already have a subscription</h2>
    <p>Expires on: <%= subscription.expiry.toDateString() %></p>
<% } else { %>
    <form action="/subscription" method="POST">
        <select name="amount" id="amount">
            <option value="400" default>Rs. 400 - 1 months</option>
            <option value="800">Rs. 1200 - 3 months</option>
            <option value="1200">Rs. 2400 - 6 months</option>
            <option value="4800">Rs. 4800 - 12 months</option>
        </select>
        <div id="card-element"></div>
        <div id="card-errors" role="alert"></div>
        <button>Pay</button>
    </form>
<% } %>



<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe('pk_test_51IVquXFKW5qJydUO6aEmx8JVccXqVlifGKzEf7OhKPuOjWNASTS7oLw4beb2hLtKqsB19geaoKZoimfZ6f35uknh00IMekg4YZ')
    const elements = stripe.elements()


    const card = elements.create('card')
    card.mount('#card-element')

    const form = document.querySelector('form')
    const errorEl = document.querySelector('#card-errors')

    // Give our token to our form 
    const stripeTokenHandler = token => {
        const hiddenInput = document.createElement('input')
        hiddenInput.setAttribute('type', 'hidden');
        hiddenInput.setAttribute('name', 'stripeToken');
        hiddenInput.setAttribute('value', token.id);
        form.appendChild(hiddenInput);

        form.submit();
    }


    // Create token from card data
    form.addEventListener('submit', e => {
        e.preventDefault();

        stripe
            .createToken(card)
            .then(res => {
                if (res.error) errorEl.textContent = res.error.message;
                else stripeTokenHandler(res.token);
            })
    })
</script>